<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Primary Meta Tags -->
    <title>Lua Editor - Made by Swift</title>
    <meta name="title" content="Lua Editor - Online Lua Code Editor">
    <meta name="description" content="Professional online Lua code editor with syntax highlighting and autocompletion.">
    <meta name="keywords" content="lua, code editor, programming, development, online editor, lua editor">
    <meta name="author" content="Swift">
    <meta name="theme-color" content="#0a0b11">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/logos/lua-icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/logos/lua-icon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/logos/lua-icon-180x180.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- External Resources -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <script src="https://unpkg.com/luaparse@0.3.1/luaparse.js"></script>

    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Lua Editor">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #0a0b11;
            font-family: 'Fira Code', monospace;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            box-shadow: 0 0 30px rgba(88, 101, 242, 0.2);
            position: relative;
            overflow: hidden;
        }

        #container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            box-shadow: inset 0 0 100px rgba(88, 101, 242, 0.1);
            pointer-events: none;
            z-index: 1;
        }

        #editor {
            width: 100%;
            height: 100%;
            opacity: 0;
            animation: fadeInEditor 0.3s ease-out forwards;
            position: relative;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        #editor::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            box-shadow:
                inset 0 0 30px rgba(88, 101, 242, 0.1),
                0 0 20px rgba(136, 192, 255, 0.1);
            z-index: 2;
        }

        @keyframes fadeInEditor {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0d0e15;
            border-radius: 3px;
            box-shadow: inset 0 0 5px rgba(88, 101, 242, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: #2d3144;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3d4260;
            box-shadow: 0 0 10px rgba(41, 98, 255, 0.3);
        }

        
        ::selection {
            background: rgba(41, 98, 255, 0.2);
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            box-shadow: 0 0 30px rgba(88, 101, 242, 0.2);
            position: relative;
            overflow: hidden;
        }

        #iconContainer {
            position: absolute;
            bottom: 20px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .icon {
            cursor: pointer;
            color: #ff4757;
            font-size: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        
        .monaco-editor .suggest-widget {
            border: 1px solid rgba(136, 192, 255, 0.2) !important;
            box-shadow: 0 0 20px rgba(88, 101, 242, 0.2) !important;
            backdrop-filter: blur(8px);
        }

        .monaco-editor .suggest-widget .monaco-list-row:hover {
            background-color: rgba(88, 101, 242, 0.2) !important;
        }

        .monaco-editor .suggest-widget .monaco-list .monaco-list-row.focused {
            background-color: rgba(88, 101, 242, 0.3) !important;
        }

        
        .monaco-editor .view-line span {
            text-shadow: 0 0 2px rgba(248, 248, 242, 0.4);
        }

        
        .monaco-editor .mtk9 {
            /* keywords */
            text-shadow: 0 0 8px rgba(255, 121, 198, 0.5);
        }

        .monaco-editor .mtk20 {
            /* strings */
            text-shadow: 0 0 8px rgba(80, 250, 123, 0.5);
        }

        .monaco-editor .mtk6 {
            /* numbers */
            text-shadow: 0 0 8px rgba(255, 184, 108, 0.5);
        }

        .monaco-editor .mtk22 {
            /* functions */
            text-shadow: 0 0 8px rgba(102, 217, 239, 0.5);
        }

        .monaco-editor .monaco-scrollable-element {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .monaco-scrollable-element > .scrollbar > .slider {
            transition: all 0.1s ease-out;
        }

        .errorLine {
            text-decoration: wavy underline rgba(255, 71, 87, 0.6);
            text-decoration-skip-ink: none;
        }
        
        .errorGlyph {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23ff4757' d='M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 11a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm0-3a1 1 0 0 1-1-1V5a1 1 0 0 1 2 0v3a1 1 0 0 1-1 1z'/%3E%3C/svg%3E") center center no-repeat;
            margin-left: 5px;
            opacity: 0.7;
        }

        /* Hover message styling */
        .monaco-editor .monaco-hover {
            background-color: #1a1b26 !important;
            border: 1px solid rgba(255, 71, 87, 0.2) !important;
            border-radius: 4px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25) !important;
        }

        .monaco-editor .monaco-hover .hover-row:not(:first-child):not(:empty) {
            border-top: 1px solid rgba(255, 71, 87, 0.1) !important;
        }

        @media screen and (max-width: 768px) {
            #container {
                width: 100%;
                height: 100%;
            }
            
            #editor {
                font-size: 12px; /* Smaller font for mobile */
            }

            .icon {
                font-size: 24px; /* Smaller size for tablets */
            }
            
            .monaco-editor .suggest-widget {
                max-width: 90vw !important;
            }
        }

        @media screen and (max-width: 480px) {
            #editor {
                font-size: 11px; /* Even smaller font for very small devices */
            }
            
            ::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }

            .icon {
                font-size: 20px; /* Even smaller size for mobile */
            }

            #iconContainer {
                gap: 15px; /* Adjust gap for smaller screens */
            }
        }

        /* Add touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            #container::before {
                display: none; /* Remove shadow effect on mobile */
            }
            
            .monaco-editor .monaco-scrollable-element {
                -webkit-overflow-scrolling: touch;
            }
            
            .monaco-editor .suggest-widget {
                touch-action: manipulation;
            }
        }

        /* Handle orientation changes */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            #container {
                height: 100vh;
            }
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="editor"></div>
        <div id="iconContainer">
            <i id="saveFileButton" class="fas fa-save icon"></i>
            <i id="openFileButton" class="fas fa-folder-open icon"></i>
            <i id="clearButton" class="fas fa-trash icon"></i>
        </div>
    </div>
    <script>
        // Initialize Monaco Editor
        window.onload = () => {
            require.config({
                paths: {
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs'
                }
            });

            // Initialize variables in the global scope
            window.definedVariables = new Set();
            window.definedFunctions = new Set();

            require(['vs/editor/editor.main'], function () {
                // Register Lua language
                monaco.languages.register({ id: 'lua' });

                // Create editor with advanced settings
                const editor = monaco.editor.create(document.getElementById('editor'), {
                    value: `--[[
    Neon Lua Editor
    Made with ðŸ’œ by Swift
]]

print("Hello, World!")`,
                    language: 'lua',
                    theme: 'neon-dark',
                    fontSize: 14,
                    automaticLayout: true,
                    minimap: {
                        enabled: true
                    }
                });

                // Function to parse and update context
                function updateContext(code) {
                    const lines = code.split('\n');
                    
                    // Reset context when full document is parsed
                    window.definedVariables.clear();
                    window.definedFunctions.clear();

                    lines.forEach(line => {
                        // Remove comments
                        const codeLine = line.split('--')[0];
                        
                        // Match local variable declarations
                        const localMatch = codeLine.match(/\blocal\s+([A-Za-z_][A-Za-z0-9_]*)\s*=/);
                        if (localMatch) {
                            window.definedVariables.add(localMatch[1]);
                        }

                        // Match global variable declarations
                        const globalMatch = codeLine.match(/^([A-Za-z_][A-Za-z0-9_]*)\s*=/);
                        if (globalMatch && !codeLine.trim().startsWith('local')) {
                            window.definedVariables.add(globalMatch[1]);
                        }

                        // Match function declarations
                        const functionMatch = codeLine.match(/\b(?:local\s+)?function\s+([A-Za-z_][A-Za-z0-9_]*)\s*\(/);
                        if (functionMatch) {
                            window.definedFunctions.add(functionMatch[1]);
                        }
                    });
                }

                // Register completion item provider
                monaco.languages.registerCompletionItemProvider('lua', {
                    triggerCharacters: ['.', ':'],
                    provideCompletionItems: function(model, position, context, token) {
                        const suggestions = [];
                        const lineContent = model.getLineContent(position.lineNumber);
                        const wordUntilPosition = model.getWordUntilPosition(position);
                        
                        // Check if we're in a method context (after a colon)
                        const isMethodContext = lineContent.substring(0, position.column - 1).match(/:\s*$/);
                        // Check if we're in a property context (after a dot)
                        const isPropertyContext = lineContent.substring(0, position.column - 1).match(/\.\s*$/);
                        
                        // Get the object we're working with (before the : or .)
                        let currentObject = '';
                        if (isMethodContext || isPropertyContext) {
                            const beforeCursor = lineContent.substring(0, position.column - 1);
                            const match = beforeCursor.match(/([A-Za-z_][A-Za-z0-9_]*)\s*[:.]\s*$/);
                            if (match) {
                                currentObject = match[1];
                            }
                        }

                        // Define object-specific methods and properties
                        const objectCompletions = {
                            'game': {
                                methods: [
                                    { 
                                        label: 'GetService',
                                        insertText: 'GetService("$1")',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: 'Gets a Roblox service by name'
                                    },
                                    { 
                                        label: 'FindService',
                                        insertText: 'FindService("$1")',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: 'Finds a Roblox service by name'
                                    }
                                ],
                                properties: [
                                    'Players',
                                    'Workspace',
                                    'ReplicatedStorage',
                                    'ServerStorage',
                                    'StarterGui',
                                    'StarterPack'
                                ]
                            },
                            'Instance': {
                                methods: [
                                    { 
                                        label: 'new',
                                        insertText: 'new("$1")',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: 'Creates a new instance'
                                    },
                                    { 
                                        label: 'Destroy',
                                        insertText: 'Destroy()',
                                        documentation: 'Destroys this instance'
                                    },
                                    { 
                                        label: 'Clone',
                                        insertText: 'Clone()',
                                        documentation: 'Creates a copy of this instance'
                                    }
                                ],
                                properties: [
                                    'Name',
                                    'Parent',
                                    'ClassName'
                                ]
                            }
                        };

                        // If we're in a method or property context and have object-specific completions
                        if ((isMethodContext || isPropertyContext) && objectCompletions[currentObject]) {
                            const completions = isMethodContext ? 
                                objectCompletions[currentObject].methods :
                                objectCompletions[currentObject].properties;

                            // Calculate the correct range for replacement
                            const range = {
                                startLineNumber: position.lineNumber,
                                endLineNumber: position.lineNumber,
                                startColumn: position.column - wordUntilPosition.word.length,
                                endColumn: position.column
                            };

                            completions.forEach(item => {
                                if (typeof item === 'string') {
                                    suggestions.push({
                                        label: item,
                                        kind: monaco.languages.CompletionItemKind.Property,
                                        insertText: item,
                                        range: range,
                                        filterText: item
                                    });
                                } else {
                                    suggestions.push({
                                        label: item.label,
                                        kind: monaco.languages.CompletionItemKind.Method,
                                        insertText: item.insertText,
                                        insertTextRules: item.insertTextRules,
                                        range: range,
                                        filterText: item.label,
                                        documentation: item.documentation
                                    });
                                }
                            });
                        } else {
                            // Add Roblox built-in globals
                            const robloxGlobals = [
                                { label: 'game', kind: monaco.languages.CompletionItemKind.Variable },
                                { label: 'workspace', kind: monaco.languages.CompletionItemKind.Variable },
                                { label: 'script', kind: monaco.languages.CompletionItemKind.Variable },
                                // Common Roblox services
                                { label: 'Players', kind: monaco.languages.CompletionItemKind.Class },
                                { label: 'ReplicatedStorage', kind: monaco.languages.CompletionItemKind.Class },
                                { label: 'RunService', kind: monaco.languages.CompletionItemKind.Class },
                                { label: 'TweenService', kind: monaco.languages.CompletionItemKind.Class },
                                // Common Roblox types
                                { label: 'Vector3', kind: monaco.languages.CompletionItemKind.Class },
                                { label: 'CFrame', kind: monaco.languages.CompletionItemKind.Class },
                                { label: 'Instance', kind: monaco.languages.CompletionItemKind.Class },
                                { label: 'Color3', kind: monaco.languages.CompletionItemKind.Class },
                                { label: 'UDim2', kind: monaco.languages.CompletionItemKind.Class },
                                // Common Roblox functions
                                { label: 'wait', kind: monaco.languages.CompletionItemKind.Function },
                                { label: 'spawn', kind: monaco.languages.CompletionItemKind.Function },
                                { label: 'require', kind: monaco.languages.CompletionItemKind.Function },
                                { label: 'print', kind: monaco.languages.CompletionItemKind.Function },
                                { label: 'warn', kind: monaco.languages.CompletionItemKind.Function },
                                { label: 'error', kind: monaco.languages.CompletionItemKind.Function }
                            ];

                            // Add user-defined variables
                            const userVariables = Array.from(window.definedVariables).map(v => ({
                                label: v,
                                kind: monaco.languages.CompletionItemKind.Variable,
                                detail: 'User defined variable',
                                insertText: v
                            }));

                            // Add user-defined functions
                            const userFunctions = Array.from(window.definedFunctions).map(f => ({
                                label: f,
                                kind: monaco.languages.CompletionItemKind.Function,
                                detail: 'User defined function',
                                insertText: f
                            }));

                            suggestions.push(...robloxGlobals);
                            suggestions.push(...userVariables);
                            suggestions.push(...userFunctions);
                        }

                        return {
                            suggestions: suggestions
                        };
                    }
                });

                // Update context when content changes
                let contextUpdateTimeout;
                editor.onDidChangeModelContent(() => {
                    if (contextUpdateTimeout) clearTimeout(contextUpdateTimeout);
                    contextUpdateTimeout = setTimeout(() => {
                        const model = editor.getModel();
                        if (model) {
                            const content = model.getValue();
                            updateContext(content);
                        }
                    }, 500); // Debounce context updates
                });

                // Initial context update
                const initialContent = editor.getValue();
                updateContext(initialContent);

                // Define custom Lua language configuration
                monaco.languages.setLanguageConfiguration('lua', {
                    comments: {
                        lineComment: '--',
                        blockComment: ['--[[', ']]']
                    },
                    brackets: [
                        ['{', '}'],
                        ['[', ']'],
                        ['(', ')']
                    ],
                    autoClosingPairs: [
                        { open: '{', close: '}' },
                        { open: '[', close: ']' },
                        { open: '(', close: ')' },
                        { open: '"', close: '"', notIn: ['string'] },
                        { open: "'", close: "'", notIn: ['string'] }
                    ],
                    surroundingPairs: [
                        ['{', '}'],
                        ['[', ']'],
                        ['(', ')'],
                        ['"', '"'],
                        ["'", "'"]
                    ],
                    indentationRules: {
                        increaseIndentPattern: /(((\b(else|function|then|do|repeat)\b((?!\b(end|until)\b).)*)|\(\s*function\s*\(.*\)\s*|\(\s*)|\b(elseif|if)\b\s*\(.*\)\s*)$/,
                        decreaseIndentPattern: /^\s*(\b(end|else|elseif|until)\b|[\)}])/
                    },
                    folding: {
                        markers: {
                            start: new RegExp("^\\s*--\\s*#?region\\b"),
                            end: new RegExp("^\\s*--\\s*#?endregion\\b")
                        }
                    },
                    wordPattern: /(#?-?\d*\.\d\w*)|([^\`\~\!\@\#\%\^\&\*\(\)\-\=\+\[\{\]\}\\\|\;\:\'\"\,\.\<\>\/\?\s]+)/g
                });

                // Create a custom worker for advanced error checking
                const createLuaWorker = () => {
                    const workerCode = `
                        importScripts('https://unpkg.com/luaparse@0.3.1/luaparse.js');

                        function checkLuaSyntax(code) {
                            const errors = [];
                            
                            // Split code into lines for line-by-line analysis
                            const lines = code.split('\\n');
                            
                            // Track multi-line comment state
                            let inMultiLineComment = false;
                            let multiLineCommentLevel = 0;
                            
                            try {
                                // First try full parse
                                luaparse.parse(code, {
                                    comments: true,
                                    locations: true,
                                    ranges: true,
                                    luaVersion: '5.1'
                                });
                            } catch (e) {
                                errors.push({
                                    line: e.line || 1,
                                    column: e.column || 1,
                                    message: e.message,
                                    severity: 8,
                                    endColumn: e.column + 1
                                });
                            }

                            // Additional syntax checks
                            lines.forEach((line, index) => {
                                const lineNumber = index + 1;
                                let lineContent = line;
                                
                                // Handle multi-line comments
                                if (line.includes('--[[')) {
                                    inMultiLineComment = true;
                                    multiLineCommentLevel++;
                                    lineContent = line.substring(0, line.indexOf('--[['));
                                }
                                
                                if (inMultiLineComment) {
                                    if (line.includes(']]')) {
                                        multiLineCommentLevel--;
                                        if (multiLineCommentLevel === 0) {
                                            inMultiLineComment = false;
                                            lineContent = line.substring(line.indexOf(']]') + 2);
                                        } else {
                                            return; // Skip this line if still in multi-line comment
                                        }
                                    } else {
                                        return; // Skip this line if in multi-line comment
                                    }
                                }

                                // Handle single-line comments
                                const commentStart = lineContent.indexOf('--');
                                if (commentStart !== -1 && !lineContent.substring(0, commentStart).includes('"') && !lineContent.substring(0, commentStart).includes("'")) {
                                    lineContent = lineContent.substring(0, commentStart);
                                }

                                // Skip empty lines after removing comments
                                if (!lineContent.trim()) return;

                                // Check for invalid operators and syntax
                                const invalidOperators = [
                                    { pattern: /\\+\\+/, message: 'Invalid operator "++"', length: 2 },
                                    { pattern: /--(?![\\[\\s])/, message: 'Invalid operator "--"', length: 2 },
                                    { pattern: /\\+=/, message: 'Invalid operator "+="', length: 2 },
                                    { pattern: /-=/, message: 'Invalid operator "-="', length: 2 },
                                    { pattern: /\\*=/, message: 'Invalid operator "*="', length: 2 },
                                    { pattern: /\\/=/, message: 'Invalid operator "/="', length: 2 },
                                    { pattern: /%=/, message: 'Invalid operator "%="', length: 2 }
                                ];

                                for (const op of invalidOperators) {
                                    const match = lineContent.match(op.pattern);
                                    if (match) {
                                        const startColumn = lineContent.indexOf(match[0]) + 1;
                                        errors.push({
                                            line: lineNumber,
                                            column: startColumn,
                                            endColumn: startColumn + op.length,
                                            message: op.message,
                                            severity: 8
                                        });
                                    }
                                }

                                // Check for missing 'then' in if statements
                                const ifStatement = lineContent.match(/\\bif\\b(.*?)(?:then|$)/);
                                if (ifStatement && !lineContent.includes('then') && !lineContent.endsWith('\\\\')) {
                                    const startColumn = lineContent.indexOf('if') + 1;
                                    errors.push({
                                        line: lineNumber,
                                        column: startColumn,
                                        endColumn: lineContent.length + 1,
                                        message: 'Missing "then" in if statement',
                                        severity: 8
                                    });
                                }

                                // Check for invalid parentheses
                                const openParens = (lineContent.match(/\\(/g) || []).length;
                                const closeParens = (lineContent.match(/\\)/g) || []).length;
                                if (closeParens > openParens) {
                                    const startColumn = lineContent.indexOf(')') + 1;
                                    errors.push({
                                        line: lineNumber,
                                        column: startColumn,
                                        endColumn: startColumn + 1,
                                        message: 'Unexpected closing parenthesis',
                                        severity: 8
                                    });
                                }

                                // Check for invalid syntax in local declarations
                                if (lineContent.includes('local')) {
                                    const afterLocal = lineContent.split('local')[1].trim();
                                    if (afterLocal.startsWith(')') || afterLocal.startsWith('}') || afterLocal.startsWith(']')) {
                                        const startColumn = lineContent.indexOf('local') + 6;
                                        errors.push({
                                            line: lineNumber,
                                            column: startColumn,
                                            endColumn: startColumn + 1,
                                            message: 'Invalid syntax after local declaration',
                                            severity: 8
                                        });
                                    }
                                }
                            });

                            return {
                                success: errors.length === 0,
                                errors: errors
                            };
                        }

                        self.onmessage = function(e) {
                            const result = checkLuaSyntax(e.data);
                            self.postMessage(result);
                        };
                    `;

                    const blob = new Blob([workerCode], { type: 'application/javascript' });
                    return new Worker(URL.createObjectURL(blob));
                };

                const luaWorker = createLuaWorker();

                luaWorker.onmessage = function(e) {
                    const model = editor.getModel();
                    const markers = e.data.errors.map(error => ({
                        severity: error.severity || monaco.MarkerSeverity.Error,
                        message: error.message,
                        startLineNumber: error.line,
                        startColumn: error.column,
                        endLineNumber: error.line,
                        endColumn: error.endColumn || (error.column + 1),
                        source: 'lua'
                    }));
                    monaco.editor.setModelMarkers(model, 'lua', markers);
                };

                // Add CSS for error styling
                const errorStyle = document.createElement('style');
                errorStyle.textContent = `
                    .monaco-editor .squiggly-error {
                        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 6 3'%3E%3Cg fill='%23ff0000'%3E%3Cpolygon points='5.5%2C0 2.5%2C3 1.1%2C3 4.1%2C0'%2F%3E%3Cpolygon points='4%2C0 6%2C2 6%2C0.6 5.4%2C0'%2F%3E%3Cpolygon points='0%2C2 1%2C3 2.4%2C3 0%2C0.6'%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E") repeat-x bottom left;
                        padding-bottom: 3px;
                    }
                    .monaco-editor .error-glyph {
                        background: #ff0000;
                        width: 5px !important;
                        margin-left: 3px;
                    }
                `;
                document.head.appendChild(errorStyle);

                // Check syntax on content change with debounce
                let syntaxCheckTimeout;
                editor.onDidChangeModelContent(() => {
                    if (syntaxCheckTimeout) clearTimeout(syntaxCheckTimeout);
                    syntaxCheckTimeout = setTimeout(() => {
                        const model = editor.getModel();
                        if (model) {
                            const content = model.getValue();
                            luaWorker.postMessage(content);
                        }
                    }, 500); // Debounce syntax checking
                });

                // Override validation using the correct API
                monaco.languages.register({
                    id: 'lua',
                    extensions: ['.lua'],
                    aliases: ['Lua', 'lua'],
                    mimetypes: ['text/x-lua']
                });

                // Set up custom worker to handle validation
                self.MonacoEnvironment = {
                    getWorkerUrl: function(moduleId, label) {
                        return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
                            self.onmessage = function() {
                                self.postMessage({ markers: [] });
                            };
                        `)}`;
                    }
                };

                // Disable markers using the correct API
                monaco.languages.onLanguage('lua', () => {
                    monaco.languages.setLanguageConfiguration('lua', {
                        comments: {
                            lineComment: '--',
                            blockComment: ['--[[', ']]']
                        },
                        brackets: [
                            ['{', '}'],
                            ['[', ']'],
                            ['(', ')']
                        ],
                        autoClosingPairs: [
                            { open: '{', close: '}' },
                            { open: '[', close: ']' },
                            { open: '(', close: ')' },
                            { open: '"', close: '"', notIn: ['string'] },
                            { open: "'", close: "'", notIn: ['string'] }
                        ],
                        surroundingPairs: [
                            ['{', '}'],
                            ['[', ']'],
                            ['(', ')'],
                            ['"', '"'],
                            ["'", "'"]
                        ],
                        indentationRules: {
                            increaseIndentPattern: /(((\b(else|function|then|do|repeat)\b((?!\b(end|until)\b).)*)|\(\s*function\s*\(.*\)\s*|\(\s*)|\b(elseif|if)\b\s*\(.*\)\s*)$/,
                            decreaseIndentPattern: /^\s*(\b(end|else|elseif|until)\b|[\)}])/
                        },
                        folding: {
                            markers: {
                                start: new RegExp("^\\s*--\\s*#?region\\b"),
                                end: new RegExp("^\\s*--\\s*#?endregion\\b")
                            }
                        },
                        onEnterRules: [
                            {
                                beforeText: /:\s*Connect\s*\(\s*function\s*\([^)]*\)\s*$/,
                                action: { indentAction: monaco.languages.IndentAction.Indent }
                            },
                            {
                                beforeText: /\bend\)\s*$/,
                                action: { indentAction: monaco.languages.IndentAction.Outdent }
                            }
                        ]
                    });
                });

                // Override the model markers on content change
                editor.onDidChangeModelContent(() => {
                    const model = editor.getModel();
                    if (model) {
                        monaco.editor.setModelMarkers(model, 'lua', []);
                    }
                });

                // Add to the editor options
                editor.updateOptions({
                    renderValidationDecorations: 'on',
                    minimap: {
                        enabled: true,
                        showSlider: 'always',
                        renderCharacters: false,
                        maxColumn: 120,
                        scale: 1
                    }
                });

                // Add this after editor creation
                editor.onDidChangeModelContent(() => {
                    const code = editor.getValue();
                    luaWorker.postMessage(code);
                });

                // Initial syntax check
                luaWorker.postMessage(editor.getValue());

                // Add clear button functionality
                document.getElementById('clearButton').addEventListener('click', () => {
                    editor.setValue(''); // Clear the content in the editor
                });

                // Open file functionality
                document.getElementById('openFileButton').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.lua';
                    input.onchange = e => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = event => {
                            editor.setValue(event.target.result); // Set the content in the editor to the file content
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                });

                // Save file functionality
                document.getElementById('saveFileButton').addEventListener('click', () => {
                    const blob = new Blob([editor.getValue()], { type: 'text/x-lua' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'script.lua'; // Default file name
                    link.click();
                });

                // Register Lua completion provider
                monaco.languages.registerCompletionItemProvider('lua', {
                    provideCompletionItems: (model, position) => {
                        const wordUntilPosition = model.getWordUntilPosition(position);
                        const range = {
                            startLineNumber: position.lineNumber,
                            endLineNumber: position.lineNumber,
                            startColumn: wordUntilPosition.startColumn,
                            endColumn: wordUntilPosition.endColumn
                        };

                        const suggestions = [
                            {
                                label: 'print',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'print(${1:value})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Prints a value to the console'
                            },
                            {
                                label: 'Instance.new',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'Instance.new("${1:ClassName}")',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Creates a new Roblox instance'
                            },
                            {
                                label: 'Vector3.new',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'Vector3.new(${1:x}, ${2:y}, ${3:z})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Creates a new Vector3'
                            },
                            {
                                label: 'task.wait',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'task.wait(${1:seconds})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Yields the current thread for the specified duration'
                            },
                            {
                                label: 'local function',
                                kind: monaco.languages.CompletionItemKind.Snippet,
                                insertText: [
                                    'local function ${1:name}(${2:params})',
                                    '\t${3:-- body}',
                                    'end'
                                ].join('\n'),
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                            },
                            {
                                label: ':WaitForChild',
                                kind: monaco.languages.CompletionItemKind.Method,
                                insertText: ':WaitForChild("${1:name}"${2:, ${3:timeout}})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Waits for a child instance with the given name'
                            },
                            {
                                label: ':FindFirstChild',
                                kind: monaco.languages.CompletionItemKind.Method,
                                insertText: ':FindFirstChild("${1:name}"${2:, ${3:recursive}})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Finds the first child instance with the given name'
                            },
                            {
                                label: 'Color3.fromRGB',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'Color3.fromRGB(${1:r}, ${2:g}, ${3:b})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Creates a Color3 value from RGB values (0-255)'
                            },
                            {
                                label: 'UDim2.new',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'UDim2.new(${1:scaleX}, ${2:offsetX}, ${3:scaleY}, ${4:offsetY})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Creates a new UDim2 value'
                            },
                            {
                                label: ':Connect',
                                kind: monaco.languages.CompletionItemKind.Method,
                                insertText: ':Connect(function(${1:...})\n\t${2:-- body}\nend)',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Connects a function to an event'
                            },
                            {
                                label: 'game:GetService',
                                kind: monaco.languages.CompletionItemKind.Method,
                                insertText: 'game:GetService("${1|Players,ReplicatedStorage,Workspace,Lighting,RunService,TweenService,UserInputService,HttpService,PhysicsService,SoundService,StarterGui,StarterPack,Teams,TextService,Debris,MarketplaceService|}")',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Gets a Roblox service by name'
                            },
                            {
                                label: 'loadstring',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'loadstring(game:HttpGet(\'${1:url}\'))()',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Loads and executes code from a URL using HttpGet'
                            },
                            {
                                label: 'HttpGet',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'game:HttpGet("${1:url}")',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Sends an HTTP GET request and returns the response'
                            },
                            {
                                label: 'HttpPost',
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertText: 'game:HttpPost("${1:url}", ${2:data})',
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                documentation: 'Sends an HTTP POST request with data'
                            }
                        ];

                        return { suggestions };
                    },
                    triggerCharacters: ['.', ':', '_']
                });

                // Variable tracking system
                let definedVariables = new Set();
                let variableDeclarationRegex = /\blocal\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;
                let functionDeclarationRegex = /\bfunction\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;
                let localFunctionRegex = /\blocal\s+function\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;

                editor.onDidChangeModelContent((e) => {
                    const model = editor.getModel();
                    const content = model.getValue();

                    // Clear previous variables
                    definedVariables.clear();

                    // Find all variable declarations
                    let match;
                    while ((match = variableDeclarationRegex.exec(content)) !== null) {
                        definedVariables.add({
                            name: match[1],
                            kind: 'variable',
                            location: model.getPositionAt(match.index)
                        });
                    }

                    // Find all function declarations
                    while ((match = functionDeclarationRegex.exec(content)) !== null) {
                        definedVariables.add({
                            name: match[1],
                            kind: 'function',
                            location: model.getPositionAt(match.index)
                        });
                    }

                    // Find all local function declarations
                    while ((match = localFunctionRegex.exec(content)) !== null) {
                        definedVariables.add({
                            name: match[1],
                            kind: 'function',
                            location: model.getPositionAt(match.index)
                        });
                    }
                });

                // Add hover provider for defined variables
                monaco.languages.registerHoverProvider('lua', {
                    provideHover: (model, position) => {
                        const word = model.getWordAtPosition(position);
                        if (!word) return;

                        const variable = [...definedVariables].find(v => v.name === word.word);
                        if (variable) {
                            return {
                                contents: [
                                    { value: `**${variable.kind === 'function' ? 'Function' : 'Variable'}**: \`${variable.name}\`` },
                                    { value: `Defined at line ${variable.location.lineNumber}` }
                                ]
                            };
                        }
                    }
                });

                // Define custom theme
                monaco.editor.defineTheme('neon-dark', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: '6272a4', fontStyle: 'italic' },
                        { token: 'keyword', foreground: 'ff79c6', fontStyle: 'bold' },  // Bright pink
                        { token: 'string', foreground: '50fa7b' },   // Neon green
                        { token: 'number', foreground: 'ffb86c' },   // Bright orange
                        { token: 'operator', foreground: '8be9fd' }, // Cyan
                        { token: 'type.identifier', foreground: 'bd93f9' }, // Purple
                        { token: 'function', foreground: '66d9ef', fontStyle: 'bold' }, // Blue
                        { token: 'variable', foreground: 'f8f8f2' }, // Bright white
                        { token: 'constant', foreground: 'bd93f9' }  // Purple
                    ],
                    colors: {
                        'editor.background': '#0a0b11',
                        'editor.foreground': '#f8f8f2',
                        'editor.lineHighlightBackground': '#1a1b2644',
                        'editor.lineHighlightBorder': '#1a1b2600',
                        'editor.selectionBackground': '#44475a',
                        'editor.inactiveSelectionBackground': '#1f2233',
                        'editorCursor.foreground': '#bd93f9',
                        'editorCursor.background': '#282a36',
                        'editorWhitespace.foreground': '#3b3b4d',
                        'editorLineNumber.foreground': '#6272a4',
                        'editorLineNumber.activeForeground': '#ff79c6',
                        'editor.selectionHighlightBackground': '#44475a77',
                        'editor.wordHighlightBackground': '#44475a77',
                        'editor.wordHighlightStrongBackground': '#44475a77',
                        'editorBracketMatch.background': '#44475a77',
                        'editorGutter.background': '#0a0b11',
                        'editorWidget.background': '#1a1b26',
                        'editorSuggestWidget.background': '#12131a',
                        'editorSuggestWidget.border': '#2d3144',
                        'editorSuggestWidget.selectedBackground': 'rgba(88, 101, 242, 0.2)',
                        'editorSuggestWidget.highlightForeground': '#50fa7b',
                        'editorSuggestWidget.focusHighlightForeground': '#8be9fd',
                        'editorHoverWidget.background': '#12131a',
                        'editorHoverWidget.border': '#2d3144',
                        'editorIndentGuide.background': '#1a1b26',
                        'editorIndentGuide.activeBackground': '#2d3144',
                        'list.hoverBackground': 'rgba(88, 101, 242, 0.1)',
                        'list.focusBackground': 'rgba(88, 101, 242, 0.2)',
                        'list.activeSelectionBackground': 'rgba(88, 101, 242, 0.3)',
                        'list.highlightForeground': '#50fa7b'
                    }
                });

                monaco.editor.setTheme('neon-dark');

                // Handle window resize
                window.addEventListener('resize', () => {
                    editor.layout();
                });

                window.editor = editor;

                // Add drag and drop support
                const editorElement = document.getElementById('editor');

                editorElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    editorElement.style.opacity = '0.7';
                });

                editorElement.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    editorElement.style.opacity = '1';
                });

                editorElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    editorElement.style.opacity = '1';

                    const file = e.dataTransfer.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const content = event.target.result;
                            editor.setValue(content);
                            
                            // Trigger syntax check after setting value
                            luaWorker.postMessage(content);

                            // Attempt to detect and set the language mode
                            const fileName = file.name.toLowerCase();
                            if (fileName.endsWith('.lua')) {
                                monaco.editor.setModelLanguage(editor.getModel(), 'lua');
                            }
                        };
                        reader.readAsText(file);
                    }
                });

                // Add some CSS for drag and drop visual feedback
                const style = document.createElement('style');
                style.textContent = `
                    #editor.drag-over {
                        border: 2px dashed rgba(88, 101, 242, 0.5);
                        background-color: rgba(88, 101, 242, 0.1);
                    }
                `;
                document.head.appendChild(style);
            });
        };
        
    </script>
</body>

</html>